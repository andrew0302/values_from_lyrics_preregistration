---
title: "14_machine_IRR"
author: "Andrew M. Demetriou"
date: "`r Sys.Date()`"
---

```{r}
library('here')            # file logistics
library('data.table')      # data manipulation
library('dplyr')           # data manipulation
library('tidyr')           # data manipulation
library('ggplot2')         # visualization
library('ggridges')        # joyplot visualization
library('psych')           # intra class correlation

machines_as_subjects_df <- readRDS(here("VI_data_collection", "_data", "machine_response_data", "machines_as_subjects_df.RDS"))

# include names of variables
values<-c("POWER", "ACHIEVEMENT", "HEDONISM",  
          "STIMULATION", "SELF", "UNIVERSALISM", 
          "BENEVOLENCE", "TRADITION",  
          "CONFORMITY", "SECURITY")
```

```{r}
machines_as_subjects_df %>%
  pivot_longer(cols = POWER:SECURITY) %>%
  ggplot(aes(x=value, group=name, col = name)) +
  #geom_density()
  geom_line(stat='density', alpha = 0.5)
```

```{r}
# create a dataframe of ICC results for each value
list_of_icc_dfs <-  lapply(values, function(value){
  df <- machines_as_subjects_df %>% dplyr::select(participant_ID, item_ID, value) %>%
    pivot_wider(names_from = participant_ID, values_from = value)
  icc_df <- df %>% select(-item_ID) %>% ICC()
  icc_df <- icc_df$results %>% filter(type =="ICC2k" | type == "ICC2")
  icc_df$value <- value
  return(icc_df)
})

icc_df <- rbindlist(list_of_icc_dfs)
```

```{r}
icc_df %>%
  ggplot(aes(x=ICC, y=value, color = type, group=type)) +
  geom_point() +
  geom_errorbar(xmin = icc_df$`lower bound`, xmax = icc_df$`upper bound`)

icc_df %>% group_by(type) %>%
  dplyr::summarize(mean = mean(ICC), sd = sd(ICC))

rm(icc_df)
```

```{r}
# load lme4 functions
source(here("VI_data_collection_november_2022", "functions", "lme4_descriptives_function_1.7.R"))

# load mplus functions
source(here("VI_data_collection_november_2022", "functions", "mplus_descriptives_function_1.6.R"))
```

```{r}
# select only ID columns and values scores
df <- machines_as_subjects %>% select(participant_ID, item_ID, all_of(values))

# rename columns to have same names as in functions
colnames(df) <- c("subject_ID", "item_ID", values)
```

```{r}
# run lmer models for each value as the dependent variable 

# extract standard deviation 95% CI for participants and songs by value

 lme4_random_effect_sd_dt <- df |> 
   assemble_random_effect_sd_dt()

# save object
# save(lme4_random_effect_sd_dt, file = here("VI_data_collection_november_2022", "intermediary_data", "lme4_random_effect_sd_dt.RDS"))

#load(here("VI_data_collection_november_2022", "intermediary_data", "lme4_random_effect_sd_dt.RDS"))
```


```{r}
# plot estimated SD for participant random effect, by value and software
lme4_random_effect_sd_dt %>%
  ggplot(aes(x=model, y=subject_ID, color = model)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=subject_ID_lower, ymax=subject_ID_higher)) +
  theme(axis.text.x = element_text(angle = 45)) +
  xlab("") +
  ylab("") +
  guides(color = 'none') +
  ggtitle("participant random effect SD")
```

```{r}
# plot estimated SD for participant random effect, by value and software
lme4_random_effect_sd_dt %>%
  ggplot(aes(x=model, y=item_ID, color = model)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=item_ID_lower, ymax=item_ID_higher)) +
  theme(axis.text.x = element_text(angle = 45)) +
  xlab("") +
  ylab("") +
  guides(color = 'none') +
  ggtitle("item random effect SD")
```

```{r}
lme4_intercept_and_predicted_dt %>%
  group_by(value) %>%
  ggplot(aes(x= intercept, y = value, fill =value, alpha = 0.7)) +
  geom_density_ridges() + 
  theme(legend.position = "none") + 
  xlab("item intecepts") + 
  ylab("schwartz value")
```

